# with를 사용한 컨텍스트 매니저

파이썬에서는 사용한 파일을 닫지 않으면 파일에 이상이 생길 수 있기 때문에, 파일을 연 후에는 항상 닫아야 합니다.

이때 close()라는 메서드를 사용하게 되는데, 때로는 close() 메서드를 반복적으로 사용하기 귀찮을 때가 있습니다.

또, 코드가 복잡해지다보면 파일을 닫기 전에 에러가 발생할 가능성이 높아집니다. 에러가 발생했을 경우에는 파일이 닫히지도 않습니다.

이럴때 "with"라는 키워드를 사용하여 파일을 자동으로 닫는 방법을 사용할 수 있습니다.

with 문은 코드를 실행했을 때 에러가 발생하든 안하든 마지막에 close()를 해주기 때문입니다.

컨텍스트 매니저란 with문에서 사용하도록 설계된 객체로 아래와 같은 코드로 진행됩니다.

```
with open("example.txt", "w") as mainFile:
  mainFile.write("testing123")
```

# **enter**와 **exit**

`__enter__`와 `__exit__`는 with 키워드를 사용하여 쉽게 파일이 열리도록 하는 메소드입니다.

with 코드가 실행되면 컨텍스트 매니저가 자동적으로 enter() 메소드를 실행하고, 예외적인 상황이 생겨도 exit() 메서드는 호출을 보장하게 됩니다.

```
with open("a.txt", "w") as mf:
  mf.write("Hello World")
```

위의 코드는 아래의 코드와 같은 기능을 합니다. 아래 코드에 있는 try는 후술하도록 하겠습니다.

```
mf = open("a.txt", "w")
try:
  mf.write("Hello World")
finally:
  mf.close()
```

우리가 정의한 컨텍스트 매니저 with문에서 open() 대신하여 사용할 수 있는 클래스를 만들어 보겠습니다.

```
class fileManager:
  def __init__(self, fileName):
    self.fileName = fileName

  def __enter__(self):
    self.file = open(self.name, "w", encoding = "UTF-8")
    return self.file

  def __exit__(self, type, value, tb):
    if self.file:
      self.file.close()

with fileManager("hello.txt") as mf:
  mf.write("Hello World")
```

`__enter__()`는 파일을 여는 역할의 함수이기 때문에, 읽은 파일을 꼭 반환해야 합니다.

`__exit__()`는 작업이 끝난 후 실행할 코드이기 때문에, 꼭 exit에서 파일을 닫아야 합니다.
